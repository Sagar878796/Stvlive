<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>STV Live</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.compiled.js"></script>

<style>
body{margin:0;background:black;color:white;font-family:Arial}
video{width:100%;height:60vh;background:black}
#channels{height:40vh;overflow:auto;background:#111}
.channel{padding:12px;border-bottom:1px solid #333;cursor:pointer}
.channel:hover{background:#222}
</style>

</head>
<body>

<video id="video" controls autoplay></video>

<div id="channels">Loading...</div>

<script>

const PLAYLIST =
"https://sagar878796.github.io/Stvlive/playlist.m3u";

const video =
document.getElementById("video");

const player =
new shaka.Player(video);


// dynamic headers
let currentHeaders = {};

player.getNetworkingEngine().registerRequestFilter(
(type, request)=>{

request.headers['User-Agent'] =
currentHeaders['User-Agent'] ||
"Mozilla/5.0 (Linux; Android 10) Chrome/120 Mobile Safari/537.36";

if(currentHeaders['Referer'])
request.headers['Referer'] =
currentHeaders['Referer'];

if(currentHeaders['Origin'])
request.headers['Origin'] =
currentHeaders['Origin'];

});


async function loadPlaylist(){

const res =
await fetch(PLAYLIST);

const text =
await res.text();

const lines =
text.split("\n");

let channels = [];

let userAgent = null;

for(let i=0;i<lines.length;i++){

if(lines[i].includes("http-user-agent=")){

userAgent =
lines[i].split("=")[1];

}

if(lines[i].startsWith("#EXTINF")){

const name =
lines[i].split(",")[1];

let url =
lines[i+1];

let referer = null;

if(url.includes("|Referer=")){

referer =
url.split("|Referer=")[1];

url =
url.split("|Referer=")[0];

}

channels.push({
name,
url,
userAgent,
referer
});

userAgent = null;

}

}

showChannels(channels);

}


function showChannels(channels){

const div =
document.getElementById("channels");

div.innerHTML="";

channels.forEach(ch=>{

const el =
document.createElement("div");

el.className="channel";

el.innerText=ch.name;

el.onclick=()=>playChannel(ch);

div.appendChild(el);

});

}


async function playChannel(ch){

currentHeaders = {};

if(ch.userAgent)
currentHeaders['User-Agent'] =
ch.userAgent;

if(ch.referer){

currentHeaders['Referer'] =
ch.referer;

currentHeaders['Origin'] =
new URL(ch.referer).origin;

}

try{

await player.load(ch.url);

console.log("Playing:",ch.name);

}catch(e){

alert("Error: "+e.message);

}

}


loadPlaylist();

</script>

</body>
</html>
